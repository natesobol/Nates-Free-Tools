<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extract Text Inside Quotes | Monetize Hub Tools</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../../../public/css/styles.css" />
    <link rel="stylesheet" href="../../../public/css/webapp-theme.css" />
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  </head>
  <body class="tool-page">
    <header class="site-header">
      <div class="header-top">
        <a class="brand" href="../../../index.html">
          <img src="../../../public/logo.png" alt="Monetize Hub" class="brand-logo" />
          <div class="brand-text">
            <span class="brand-name">Monetize Hub</span>
            <span class="brand-tagline">Launch, host, and grow your webapps</span>
          </div>
        </a>
        <details class="nav-dropdown user-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">
            <span class="user-label">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>
          <div class="nav-dropdown-menu">
            <a href="../../../login.html" class="dropdown-link">Login</a>
            <a href="../../../register.html" class="dropdown-link">Create Account</a>
            <a href="../../../admin.html" class="dropdown-link">Admin Dashboard</a>
          </div>
        </details>
      </div>
      <nav class="main-nav">
        <a href="../../../index.html" class="nav-link">Home</a>
        <a href="../../../about.html" class="nav-link">About</a>
        <details class="nav-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">Webapps <span aria-hidden="true">▾</span></summary>
          <div class="nav-dropdown-menu">
            <a href="../../../apps/excel-to-json/index.html" class="dropdown-link">Excel → JSON</a>
            <a href="../../../apps/json-to-excel/wwwroot/index.html" class="dropdown-link">JSON → Excel</a>
            <a href="../../../apps/xml-json-translator/index.html" class="dropdown-link">XML ⇄ JSON Translator</a>
            <a href="../../../apps/yaml-json-converter/index.html" class="dropdown-link">YAML ↔ JSON Converter</a>
            <a href="../../../apps/json-combiner/wwwroot/index.html" class="dropdown-link">JSON Combiner</a>
            <a href="../../../apps/find-and-replace/wwwroot/index.html" class="dropdown-link">Find &amp; Replace</a>
            <a href="../../../apps/csv-xml-converter/index.html" class="dropdown-link">CSV/XML Converter</a>
            <a href="../../../apps/list-comparison/wwwroot/index.html" class="dropdown-link">List Comparison / Diff Checker</a>
            <a href="../../../apps/text-url-extractor/wwwroot/index.html" class="dropdown-link">Text URL Extractor</a>
            <a href="../../../apps/email-thread-extractor/index.html" class="dropdown-link">Email Thread Extractor</a>
            <a href="../../../apps/extract-text-inside-quotes/wwwroot/index.html" class="dropdown-link active">Extract Text Inside Quotes</a>
            <a href="../../../apps/pdf-splitter/wwwroot/index.html" class="dropdown-link">PDF Splitter</a>
            <a href="../../../apps/bullet-list-extractor/wwwroot/index.html" class="dropdown-link">Bullet List Extractor</a>
            <a href="../../../apps/powerpoint-to-pdf/wwwroot/index.html" class="dropdown-link">PowerPoint → PDF</a>
            <a href="../../../apps/powerpoint-image-extractor/wwwroot/index.html" class="dropdown-link">PowerPoint Image Extractor</a>
          </div>
        </details>
      </nav>
    </header>

    <main class="tool-shell">
      <div class="app-shell">
        <header class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-3">
          <div>
            <p class="badge-pill mb-2">Paste or upload text sources</p>
            <h1 class="page-title mb-1">Extract Text Inside Quotes</h1>
            <p class="muted mb-0">
              Drop docs, emails, or code snippets to instantly pull phrases found inside single or double quotes.
            </p>
          </div>
          <img
            src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/275d.svg"
            width="72"
            height="72"
            alt="Quotation mark"
          />
        </header>

        <div class="card-gradient mb-4">
          <label for="textInput" class="form-label fw-semibold">Paste text</label>
          <textarea
            id="textInput"
            class="form-control"
            rows="6"
            placeholder="Paste email threads, chat logs, code, or blog content here..."
          ></textarea>

          <div class="dropzone mt-3" id="dropzone">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
              <div>
                <p class="mb-1 fw-semibold">Upload files</p>
                <p class="muted mb-0">
                  Accepts DOCX, TXT, MD, JSON, HTML, EML, MSG, and other text-friendly formats. Files never leave your device.
                </p>
              </div>
              <label class="button ghost btn btn-outline-light btn-modern mb-0" for="fileInput">Choose files</label>
              <input id="fileInput" type="file" class="form-control" multiple hidden />
            </div>
            <p class="help-text mb-0">Drag and drop anywhere in this panel to add files.</p>
          </div>

          <div class="controls-grid mt-3">
            <div class="control-card">
              <label for="minWords" class="form-label">Minimum words per phrase</label>
              <input id="minWords" type="number" min="1" value="1" class="form-control" />
              <p class="form-text text-secondary">Filter out short tokens or contractions.</p>
            </div>
            <div class="control-card">
              <label for="dedupe" class="form-label">Deduplicate results</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="dedupe" checked />
                <label class="form-check-label" for="dedupe">Return unique phrases only</label>
              </div>
            </div>
            <div class="control-card">
              <label for="smartQuotes" class="form-label">Smart quote support</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="smartQuotes" checked />
                <label class="form-check-label" for="smartQuotes">Include “curly” and ‘single’ quotes</label>
              </div>
            </div>
          </div>

          <div class="d-flex align-items-center gap-3 mt-3 flex-wrap">
            <button id="extractBtn" class="btn btn-primary btn-lg px-4">Extract quotes</button>
            <button id="copyBtn" class="btn btn-secondary btn-lg px-4" disabled>Copy all</button>
            <span id="status" class="muted"></span>
          </div>
          <div id="toast" class="toast mt-3" role="status" style="display: none"></div>
        </div>

        <section aria-live="polite">
          <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
            <div>
              <h2 class="h5 mb-0">Quoted phrases</h2>
              <small class="muted">Shows lines matched across pasted text and uploaded files.</small>
            </div>
            <span class="pill" id="resultCount">0 phrases</span>
          </div>
          <ul id="results" class="results-list"></ul>
          <p id="emptyState" class="muted">No phrases yet. Paste some text or add files to get started.</p>
        </section>

        <div class="notice">
          All parsing happens in your browser. For DOCX files, only the text layer is read — images and styling are ignored.
        </div>
      </div>
    </main>

    <script>
      const textInput = document.getElementById('textInput');
      const fileInput = document.getElementById('fileInput');
      const dropzone = document.getElementById('dropzone');
      const extractBtn = document.getElementById('extractBtn');
      const copyBtn = document.getElementById('copyBtn');
      const resultsList = document.getElementById('results');
      const emptyState = document.getElementById('emptyState');
      const statusEl = document.getElementById('status');
      const toast = document.getElementById('toast');
      const minWordsInput = document.getElementById('minWords');
      const dedupeToggle = document.getElementById('dedupe');
      const smartQuotesToggle = document.getElementById('smartQuotes');
      const resultCount = document.getElementById('resultCount');

      let cachedResults = [];

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.style.display = 'block';
        toast.classList.toggle('error', isError);
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3600);
      }

      function sanitizePhrase(text) {
        return text.replace(/\s+/g, ' ').replace(/[\u0000-\u001F]/g, '').trim();
      }

      function hasEnoughWords(text, minWords) {
        return text.split(/\s+/).filter(Boolean).length >= minWords;
      }

      function buildRegexSet(includeSmartQuotes) {
        const patterns = [
          { regex: /"([^"\r\n]{1,500}?)"/g, group: 1 },
          { regex: /'([^'\r\n]{1,500}?)'/g, group: 1 }
        ];

        if (includeSmartQuotes) {
          patterns.push({ regex: /“([^”]{1,500}?)”/g, group: 1 });
          patterns.push({ regex: /‘([^’]{1,500}?)’/g, group: 1 });
        }

        return patterns;
      }

      function extractQuotesFromText(text, { minWords, includeSmartQuotes }) {
        const phrases = [];
        const patterns = buildRegexSet(includeSmartQuotes);

        for (const { regex, group } of patterns) {
          regex.lastIndex = 0;
          let match;
          while ((match = regex.exec(text)) !== null) {
            const phrase = sanitizePhrase(match[group] ?? '');
            if (!phrase || !/[\p{L}\p{N}]/u.test(phrase)) continue;
            if (!hasEnoughWords(phrase, minWords)) continue;
            phrases.push(phrase);
          }
        }

        return phrases;
      }

      async function readDocx(file) {
        const buffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(buffer);
        const docFile = zip.file('word/document.xml');
        if (!docFile) {
          throw new Error('Unable to find document.xml inside the DOCX.');
        }
        const xml = await docFile.async('string');
        const parser = new DOMParser();
        const dom = parser.parseFromString(xml, 'application/xml');
        return dom.documentElement?.textContent || '';
      }

      async function readFileAsText(file) {
        const lower = file.name.toLowerCase();
        try {
          if (lower.endsWith('.docx')) {
            return await readDocx(file);
          }
        } catch (error) {
          console.error('DOCX parsing failed', error);
          throw new Error(`${file.name}: ${error.message}`);
        }

        return await file.text();
      }

      async function collectSources() {
        const sources = [];
        const pasted = textInput.value.trim();
        if (pasted) {
          sources.push({ label: 'Pasted text', content: pasted });
        }

        const files = Array.from(fileInput.files);
        for (const file of files) {
          try {
            const text = await readFileAsText(file);
            sources.push({ label: file.name, content: text });
          } catch (error) {
            showToast(error.message || `Could not read ${file.name}`, true);
          }
        }

        return sources;
      }

      function renderResults(items) {
        resultsList.innerHTML = '';
        cachedResults = items;
        resultCount.textContent = `${items.length} phrase${items.length === 1 ? '' : 's'}`;

        if (!items.length) {
          emptyState.style.display = 'block';
          copyBtn.disabled = true;
          return;
        }

        emptyState.style.display = 'none';
        copyBtn.disabled = false;

        items.forEach((item, index) => {
          const li = document.createElement('li');
          li.classList.add('result');

          const title = document.createElement('div');
          title.classList.add('d-flex', 'align-items-center', 'justify-content-between', 'gap-2', 'flex-wrap');

          const heading = document.createElement('h3');
          heading.classList.add('h6', 'mb-1');
          heading.textContent = item.phrase;

          const badge = document.createElement('span');
          badge.classList.add('pill');
          badge.textContent = item.sources.join(', ');

          title.appendChild(heading);
          title.appendChild(badge);
          li.appendChild(title);

          const copyLine = document.createElement('button');
          copyLine.type = 'button';
          copyLine.classList.add('btn', 'btn-sm', 'btn-outline-light', 'btn-modern');
          copyLine.textContent = 'Copy phrase';
          copyLine.addEventListener('click', () => {
            navigator.clipboard.writeText(item.phrase);
            showToast('Copied phrase to clipboard');
          });

          li.appendChild(copyLine);
          resultsList.appendChild(li);
        });
      }

      async function handleExtract() {
        statusEl.textContent = 'Extracting…';
        resultsList.innerHTML = '';
        renderResults([]);

        const minWords = Number(minWordsInput.value) || 1;
        const includeSmartQuotes = smartQuotesToggle.checked;
        const dedupe = dedupeToggle.checked;

        try {
          const sources = await collectSources();
          if (!sources.length) {
            statusEl.textContent = '';
            emptyState.style.display = 'block';
            showToast('Add text or files to extract phrases.', true);
            return;
          }

          const merged = [];
          for (const source of sources) {
            const phrases = extractQuotesFromText(source.content, { minWords, includeSmartQuotes });
            phrases.forEach((phrase) => merged.push({ phrase, source: source.label }));
          }

          const combined = dedupe
            ? (() => {
                const map = new Map();
                for (const item of merged) {
                  const existing = map.get(item.phrase);
                  if (existing) {
                    existing.sources.add(item.source);
                  } else {
                    map.set(item.phrase, { phrase: item.phrase, sources: new Set([item.source]) });
                  }
                }
                return Array.from(map.values()).map((entry) => ({
                  phrase: entry.phrase,
                  sources: Array.from(entry.sources)
                }));
              })()
            : merged.map((item) => ({ phrase: item.phrase, sources: [item.source] }));

          renderResults(combined);
          statusEl.textContent = combined.length ? 'Done' : 'No phrases found';
        } catch (error) {
          console.error(error);
          statusEl.textContent = '';
          showToast(error.message || 'Failed to extract quotes.', true);
        }
      }

      function handleCopyAll() {
        if (!cachedResults.length) return;
        const text = cachedResults.map((item) => item.phrase).join('\n');
        navigator.clipboard.writeText(text);
        showToast('Copied all phrases to clipboard');
      }

      dropzone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
      dropzone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropzone.classList.remove('dragover');
        if (event.dataTransfer?.files?.length) {
          fileInput.files = event.dataTransfer.files;
        }
      });

      extractBtn.addEventListener('click', handleExtract);
      copyBtn.addEventListener('click', handleCopyAll);
    </script>
  </body>
</html>
