<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-CSV Column Merger</title>
    <link rel="stylesheet" href="../../../public/css/webapp-theme.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<main>
    <header class="app-header">
        <p class="pill">Merge Shopify, Stripe, CRM exportsâ€”without spreadsheets</p>
        <h1>Multi-CSV Column Merger</h1>
        <p class="muted">Upload or drop multiple CSVs, auto-detect a shared key column (email, product ID, order ID), and download a perfectly aligned dataset as CSV or Excel.</p>
    </header>

    <section class="card">
        <form id="merge-form">
            <div class="dropzone" id="dropzone">
                <strong>Drag &amp; drop CSV files here</strong>
                <p class="muted" style="margin:0.35rem 0 0;">Or click to pick files. Upload at least two CSVs.</p>
                <input type="file" id="file-input" accept=".csv" multiple style="display:none;">
            </div>
            <div class="file-list" id="file-list" style="margin-top:0.75rem;"></div>

            <div class="grid" style="margin-top:1rem; gap:1rem;">
                <label>
                    Join behavior
                    <select id="joinType" name="joinType">
                        <option value="outer">Outer join (keep all keys)</option>
                        <option value="inner">Inner join (only matching keys)</option>
                    </select>
                </label>
                <label>
                    Key column (optional)
                    <input type="text" id="key" name="key" placeholder="Example: email or product id">
                    <small class="muted">Leave blank to auto-detect a shared header.</small>
                </label>
            </div>

            <div class="actions" style="margin-top:1rem;">
                <button type="submit">Merge files</button>
                <span id="status" class="muted"></span>
            </div>
        </form>
    </section>

    <section class="card" style="margin-top:1.25rem;">
        <div id="message" style="display:none;"></div>
        <div id="summary" style="display:none; margin-bottom:1rem;"></div>
        <div class="actions" id="downloads" style="display:none; margin-bottom:1rem;">
            <button id="download-csv" type="button">Download CSV</button>
            <button id="download-xlsx" type="button" class="secondary">Download Excel (.xlsx)</button>
        </div>
        <div id="preview" style="overflow:auto;"></div>
    </section>
</main>

<script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const form = document.getElementById('merge-form');
    const status = document.getElementById('status');
    const message = document.getElementById('message');
    const summary = document.getElementById('summary');
    const preview = document.getElementById('preview');
    const downloads = document.getElementById('downloads');
    const downloadCsvBtn = document.getElementById('download-csv');
    const downloadXlsxBtn = document.getElementById('download-xlsx');

    let selectedFiles = [];
    let lastResult = null;

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    ['dragleave', 'drop'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover')));

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
        selectedFiles = Array.from(files);
        renderFiles();
    }

    function renderFiles() {
        fileList.innerHTML = '';
        selectedFiles.forEach(f => {
            const chip = document.createElement('span');
            chip.className = 'file-chip';
            chip.textContent = `${f.name} (${(f.size/1024).toFixed(1)} KB)`;
            fileList.appendChild(chip);
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (selectedFiles.length < 2) {
            showMessage('Upload at least two CSV files to merge.', true);
            return;
        }

        status.innerHTML = '<span class="loader"></span> Merging...';
        message.style.display = 'none';
        summary.style.display = 'none';
        preview.innerHTML = '';
        downloads.style.display = 'none';

        const data = new FormData();
        data.append('joinType', document.getElementById('joinType').value);
        const keyValue = document.getElementById('key').value.trim();
        if (keyValue) data.append('key', keyValue);

        selectedFiles.forEach(file => data.append('files', file));

        try {
            const res = await fetch('/api/merge', { method: 'POST', body: data });
            const payload = await res.json();

            if (!res.ok) {
                throw new Error(payload.error || 'Failed to merge files');
            }

            lastResult = payload;
            showMessage(`Merged ${payload.totalRows} rows using key "${payload.keyColumn}" (${payload.joinType} join).`, false);
            renderSummary(payload);
            renderPreview(payload);
            setupDownloads(payload);
            status.textContent = '';
        } catch (err) {
            showMessage(err.message, true);
            status.textContent = '';
        }
    });

    function showMessage(text, isError) {
        message.style.display = 'block';
        message.className = isError ? 'error' : 'success';
        message.textContent = text;
    }

    function renderSummary(payload) {
        summary.style.display = 'block';
        summary.innerHTML = `
            <div style="display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center;">
                <span class="badge">Key: ${payload.keyColumn}</span>
                <span class="badge">Rows: ${payload.totalRows}</span>
                <span class="badge">Join: ${payload.joinType}</span>
            </div>
            <div style="margin-top:0.6rem;" class="muted">Source files:</div>
            <div class="file-list" style="margin-top:0.35rem;">${payload.fileSummaries.map(f => `<span class="file-chip">${f.fileName} (${f.rows} rows)</span>`).join('')}</div>
        `;
    }

    function renderPreview(payload) {
        const limit = 25;
        const rows = payload.rows.slice(0, limit);
        const thead = `<thead><tr>${payload.columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
        const tbody = rows.map(r => `<tr>${payload.columns.map(c => `<td>${escapeHtml(r[c] || '')}</td>`).join('')}</tr>`).join('');
        const note = payload.rows.length > limit ? `<p class="muted" style="margin-top:0.5rem;">Showing first ${limit} rows.</p>` : '';
        preview.innerHTML = `<div style="overflow:auto;"> <table>${thead}<tbody>${tbody}</tbody></table></div>${note}`;
    }

    function setupDownloads(payload) {
        downloads.style.display = 'flex';
        downloadCsvBtn.onclick = () => downloadText(payload.csv, 'merged.csv', 'text/csv');
        downloadXlsxBtn.onclick = () => downloadXlsx(payload.columns, payload.rows);
    }

    function downloadText(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function downloadXlsx(columns, rows) {
        const worksheet = XLSX.utils.json_to_sheet(rows, { header: columns });
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Merged Data');
        XLSX.writeFile(workbook, 'merged.xlsx');
    }

    function escapeHtml(value) {
        return value.replace(/[&<>"']/g, (ch) => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[ch] || ch));
    }
</script>
</body>
</html>
