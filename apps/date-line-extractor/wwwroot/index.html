<!DOCTYPE html>
<html lang="en">
  <head>
    <script id="asset-base-loader">
      (function () {
        const segments = window.location.pathname.split('/').filter(Boolean);
        const repoIndex = segments.indexOf('Nates-Free-Tools');
        const baseHref = repoIndex !== -1 ? '/' + segments.slice(0, repoIndex + 1).join('/') + '/' : '/';
        let baseTag = document.querySelector('base');
        if (!baseTag) {
          baseTag = document.createElement('base');
          document.head.prepend(baseTag);
        }
        baseTag.href = baseHref;
      })();
    </script>
    <link rel="stylesheet" href="css/webapps-unified.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Date Line Extractor | Monetize Hub Tools</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      .drop-zone {
        border: 2px dashed var(--border-subtle);
        border-radius: 12px;
        padding: 26px;
        background: rgba(255, 255, 255, 0.8);
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .drop-zone.dragover {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.08);
      }
      .result-card {
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 12px 14px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 250, 255, 0.8) 100%);
      }
      .badge-pill {
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 600;
        background: #eef2ff;
        color: #4338ca;
      }
      .small-muted {
        color: #6b7280;
        font-size: 0.9rem;
      }
    </style>
    <script src="js/site-chrome.js" defer></script>
  </head>
  <body class="tool-page">
    <header class="site-header">
      <div class="header-top">
        <a class="brand" href="../../../index.html">
          <img src="../../../public/logo.png" alt="Monetize Hub" class="brand-logo" />
          <div class="brand-text">
            <span class="brand-name">Monetize Hub</span>
            <span class="brand-tagline">Launch, host, and grow your webapps</span>
          </div>
        </a>
        <details class="nav-dropdown user-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">
            <span class="user-label">Account</span>
            <span aria-hidden="true">â–¾</span>
          </summary>
          <div class="nav-dropdown-menu">
            <a href="../../../login.html" class="dropdown-link">Login</a>
            <a href="../../../register.html" class="dropdown-link">Create Account</a>
            <a href="../../../admin.html" class="dropdown-link">Admin Dashboard</a>
          </div>
        </details>
      </div>
      <nav class="main-nav">
        <a href="../../../index.html" class="nav-link">Home</a>
        <a href="../../../about.html" class="nav-link">About</a>
        <details class="nav-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">Webapps <span aria-hidden="true">â–¾</span></summary>
          <div class="nav-dropdown-menu">
            <a href="../../../apps/excel-to-json/index.html" class="dropdown-link">Excel â†’ JSON</a>
            <a href="../../../apps/json-to-excel/wwwroot/index.html" class="dropdown-link">JSON â†’ Excel</a>
            <a href="../../../apps/xml-json-translator/index.html" class="dropdown-link">XML â‡„ JSON Translator</a>
            <a href="../../../apps/yaml-json-converter/index.html" class="dropdown-link">YAML â†” JSON Converter</a>
            <a href="../../../apps/json-combiner/wwwroot/index.html" class="dropdown-link">JSON Combiner</a>
            <a href="../../../apps/find-and-replace/wwwroot/index.html" class="dropdown-link">Find &amp; Replace</a>
            <a href="../../../apps/csv-xml-converter/index.html" class="dropdown-link">CSV/XML Converter</a>
            <a href="../../../apps/list-comparison/wwwroot/index.html" class="dropdown-link">List Comparison</a>
            <a href="../../../apps/pdf-splitter/wwwroot/index.html" class="dropdown-link">PDF Splitter</a>
            <a href="../../../apps/bullet-list-extractor/wwwroot/index.html" class="dropdown-link">Bullet List Extractor</a>
            <a href="../../../apps/powerpoint-to-pdf/wwwroot/index.html" class="dropdown-link">PowerPoint â†’ PDF</a>
            <a href="../../../apps/powerpoint-image-extractor/wwwroot/index.html" class="dropdown-link">PowerPoint Image Extractor</a>
            <a href="../../../apps/question-extractor/wwwroot/index.html" class="dropdown-link">Question Extractor</a>
            <a href="../../../apps/date-line-extractor/wwwroot/index.html" class="dropdown-link active">Date Line Extractor</a>
          </div>
        </details>
      </nav>
    </header>

    <main class="tool-shell">
      <div class="app-shell">
        <header class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-4">
          <div>
            <span class="badge-pill mb-2 d-inline-flex align-items-center gap-2">
              <span aria-hidden="true">ðŸ“…</span>
              Date &amp; time aware
            </span>
            <h1 class="page-title mb-1">Date Line Extractor</h1>
            <p class="muted mb-0">
              Pull every sentence, transcript line, or log entry containing a recognizable date or time. Group results and export with timestamps.
            </p>
          </div>
          <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4c5.svg" width="72" height="72" alt="Calendar icon" />
        </header>

        <div class="card-gradient mb-4">
          <div class="row g-3 align-items-stretch">
            <div class="col-lg-8">
              <label for="fileInput" class="form-label fw-semibold">Upload notes, transcripts, or logs</label>
              <div id="dropZone" class="drop-zone" role="button" tabindex="0" aria-label="Drop files or use the picker">
                <p class="mb-1">Drag and drop files here or use the picker below.</p>
                <input
                  id="fileInput"
                  class="form-control"
                  type="file"
                  accept=".txt,.docx,.pdf,.csv,.log"
                  multiple
                />
                <small class="text-secondary">Supported: .txt, .docx, .pdf, .csv, .log</small>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="result-card h-100 d-flex flex-column justify-content-between">
                <div>
                  <label for="groupBy" class="form-label fw-semibold">Grouping</label>
                  <select id="groupBy" class="form-select" aria-label="Grouping selector">
                    <option value="none">No grouping</option>
                    <option value="day">By day</option>
                    <option value="month">By month</option>
                    <option value="year">By year</option>
                  </select>
                  <small class="small-muted">Grouping keys rely on parsed dates; time-only rows fall under "Unknown".</small>
                </div>
                <div class="d-flex align-items-center gap-2 mt-3">
                  <button id="extractBtn" class="btn btn-primary px-4" type="button">Extract Lines</button>
                  <span id="status" class="muted flex-grow-1"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <section aria-live="polite">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <h2 class="h5 mb-0">Results</h2>
              <p id="counts" class="small-muted mb-0">No files processed yet.</p>
            </div>
            <div class="d-flex gap-2">
              <button id="exportBtn" class="btn btn-outline-secondary btn-sm" type="button" disabled>Download CSV</button>
              <span id="errorBadge" class="text-danger small"></span>
            </div>
          </div>
          <div id="results" class="d-flex flex-column gap-3"></div>
          <p id="emptyState" class="muted">Upload files and click Extract to see entries with dates.</p>
        </section>

        <div class="notice mt-4">
          Files are read in-memory and never stored. Parsing covers common formats like <code>MM/DD/YYYY</code>, <code>12 Dec 2025</code>, <code>2025-12-31</code>, and <code>03:45 PM</code>.
        </div>
      </div>
    </main>

    <script>
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const groupSelect = document.getElementById('groupBy');
      const extractBtn = document.getElementById('extractBtn');
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      const emptyState = document.getElementById('emptyState');
      const countsEl = document.getElementById('counts');
      const exportBtn = document.getElementById('exportBtn');
      const errorBadge = document.getElementById('errorBadge');

      let lastResponse = null;

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const items = Array.from(e.dataTransfer.files || []);
        if (items.length) {
          fileInput.files = e.dataTransfer.files;
        }
      });

      dropZone.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fileInput.click();
        }
      });

      extractBtn.addEventListener('click', async () => {
        errorBadge.textContent = '';
        if (!fileInput.files.length) {
          errorBadge.textContent = 'Please upload at least one supported file.';
          return;
        }

        extractBtn.disabled = true;
        exportBtn.disabled = true;
        statusEl.textContent = 'Extractingâ€¦';

        const formData = new FormData();
        Array.from(fileInput.files).forEach((file) => formData.append('files', file));
        formData.append('groupBy', groupSelect.value);

        try {
          const response = await fetch('/api/extract', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({ error: response.statusText }));
            throw new Error(error.error || 'Failed to extract entries.');
          }

          lastResponse = await response.json();
          renderResults(lastResponse);
          statusEl.textContent = 'Done';
          exportBtn.disabled = lastResponse.entries?.length === 0;
        } catch (err) {
          console.error(err);
          errorBadge.textContent = err.message || 'Something went wrong.';
          statusEl.textContent = '';
          resultsEl.innerHTML = '';
          countsEl.textContent = 'No files processed yet.';
          emptyState.classList.remove('d-none');
        } finally {
          extractBtn.disabled = false;
        }
      });

      exportBtn.addEventListener('click', () => {
        if (!lastResponse || !lastResponse.entries?.length) return;
        const rows = [
          ['File', 'Group', 'Timestamp', 'NormalizedTimestamp', 'Entry', 'Matches'],
          ...lastResponse.entries.map((item) => [
            item.file,
            findGroup(item),
            item.timestamp,
            item.normalizedTimestamp || '',
            item.entry,
            (item.matches || []).join(' | '),
          ]),
        ];

        const csvContent = rows
          .map((row) => row.map((cell) => `"${String(cell || '').replace(/"/g, '""')}"`).join(','))
          .join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'date-line-results.csv';
        link.click();
        URL.revokeObjectURL(url);
      });

      function findGroup(item) {
        if (!lastResponse || lastResponse.groupBy === 'none') return '';
        if (!lastResponse.groups?.length) return 'Unknown';
        const match = lastResponse.groups.find((group) => group.entries.some((entry) => entry.entry === item.entry && entry.file === item.file));
        return match ? match.key : 'Unknown';
      }

      function renderResults(data) {
        const entries = data.entries || [];
        countsEl.textContent = `${entries.length} entries detected across ${data.groupBy === 'none' ? 'no grouping' : data.groupBy}`;
        emptyState.classList.toggle('d-none', entries.length > 0);
        resultsEl.innerHTML = '';

        if (data.groups && data.groups.length && data.groupBy !== 'none') {
          data.groups.forEach((group) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'result-card';

            const heading = document.createElement('div');
            heading.className = 'd-flex justify-content-between align-items-center mb-2';
            heading.innerHTML = `<div class="fw-semibold">${group.key}</div><span class="badge bg-light text-dark">${group.entries.length} entries</span>`;

            const list = document.createElement('div');
            list.className = 'd-flex flex-column gap-2';
            group.entries.forEach((entry) => list.appendChild(renderEntry(entry)));

            wrapper.appendChild(heading);
            wrapper.appendChild(list);
            resultsEl.appendChild(wrapper);
          });
        } else {
          entries.forEach((entry) => resultsEl.appendChild(renderEntry(entry)));
        }
      }

      function renderEntry(entry) {
        const card = document.createElement('div');
        card.className = 'result-card';

        const heading = document.createElement('div');
        heading.className = 'd-flex justify-content-between align-items-center mb-1 flex-wrap gap-2';
        heading.innerHTML = `<div class="fw-semibold">${entry.file}</div><span class="badge bg-primary-subtle text-primary">${entry.timestamp}</span>`;

        const body = document.createElement('div');
        body.textContent = entry.entry;

        const meta = document.createElement('div');
        meta.className = 'small-muted mt-1';
        meta.textContent = `Matches: ${(entry.matches || []).join(' | ')}${entry.normalizedTimestamp ? ` â€¢ Normalized: ${entry.normalizedTimestamp}` : ''}`;

        card.appendChild(heading);
        card.appendChild(body);
        card.appendChild(meta);
        return card;
      }
    </script>
  </body>
</html>
