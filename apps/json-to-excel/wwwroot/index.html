<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C# JSON to Excel Creator</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../../../public/css/styles.css" />
    <link rel="stylesheet" href="../../../public/css/webapp-theme.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="tool-page">
    <header class="site-header">
      <div class="header-top">
        <a class="brand" href="../../../index.html">
          <img src="../../../public/logo.png" alt="Monetize Hub" class="brand-logo" />
          <div class="brand-text">
            <span class="brand-name">Monetize Hub</span>
            <span class="brand-tagline">Launch, host, and grow your webapps</span>
          </div>
        </a>
        <details class="nav-dropdown user-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">
            <span class="user-label">Account</span>
            <span aria-hidden="true">▾</span>
          </summary>
          <div class="nav-dropdown-menu">
            <a href="../../../login.html" class="dropdown-link">Login</a>
            <a href="../../../register.html" class="dropdown-link">Create Account</a>
            <a href="../../../admin.html" class="dropdown-link">Admin Dashboard</a>
          </div>
        </details>
      </div>
      <nav class="main-nav">
        <a href="../../../index.html" class="nav-link">Home</a>
        <a href="../../../about.html" class="nav-link">About</a>
        <details class="nav-dropdown" open>
          <summary class="nav-link nav-dropdown-toggle">Webapps <span aria-hidden="true">▾</span></summary>
          <div class="nav-dropdown-menu">
            <a href="../../../apps/excel-to-json/index.html" class="dropdown-link">Excel → JSON</a>
            <a href="../../../apps/json-to-excel/wwwroot/index.html" class="dropdown-link active">JSON → Excel</a>
            <a href="../../../apps/xml-json-translator/index.html" class="dropdown-link">XML ⇄ JSON Translator</a>
            <a href="../../../apps/yaml-json-converter/index.html" class="dropdown-link">YAML ↔ JSON Converter</a>
            <a href="../../../apps/json-combiner/wwwroot/index.html" class="dropdown-link">JSON Combiner</a>
            <a href="../../../apps/find-and-replace/wwwroot/index.html" class="dropdown-link">Find &amp; Replace</a>
            <a href="../../../apps/csv-xml-converter/index.html" class="dropdown-link">CSV/XML Converter</a>
            <a href="../../../apps/list-comparison/wwwroot/index.html" class="dropdown-link">List Comparison / Diff Checker</a>
            <a href="../../../apps/pdf-splitter/wwwroot/index.html" class="dropdown-link">PDF Splitter</a>
            <a href="../../../apps/powerpoint-to-pdf/wwwroot/index.html" class="dropdown-link">PowerPoint → PDF</a>
            <a href="../../../apps/powerpoint-image-extractor/wwwroot/index.html" class="dropdown-link">PowerPoint Image Extractor</a>
          </div>
        </details>
      </nav>
    </header>

    <main class="tool-shell">
      <div class="page">
        <header class="tool-hero">
          <div>
            <p class="eyebrow">C# minimal API • Downloadable Excel output</p>
            <h1>JSON to Excel (.xlsx) Creator</h1>
            <p>
              Paste a JSON payload or drop a file and get a ready-to-download Excel workbook. Arrays become their own sheets,
              nested objects use dot-notation columns, and every run ships as a clean <code>.xlsx</code> file.
            </p>
          </div>
        </header>

      <section class="grid">
        <div class="card">
          <h2>Input</h2>
          <p class="help">Choose exactly one input type per run. Switch modes to paste text or drop/upload a JSON file.</p>

          <div class="radio-row" role="group" aria-label="Input mode">
            <label><input type="radio" name="mode" value="text" checked /> Paste JSON text</label>
            <label><input type="radio" name="mode" value="file" /> Upload or drop a file</label>
          </div>

          <label for="jsonText">JSON text</label>
          <textarea
            id="jsonText"
            spellcheck="false"
            placeholder='{"orders":[{"id":1021,"customer":"Acme","items":[{"sku":"A100","qty":2}]}]}'
          ></textarea>
          <p class="help">When using text mode, drag a snippet into the textarea or paste directly.</p>

          <div class="drop-area" id="dropArea" aria-label="JSON file drop area">
            <p><strong>Drop a JSON file here</strong> or click to browse.</p>
            <p class="help">Use this area only when "Upload or drop a file" mode is selected.</p>
            <input id="jsonFile" type="file" accept="application/json,.json" hidden />
          </div>

          <div class="actions">
            <button id="convertBtn" class="primary" type="button">Create Excel</button>
            <button id="sampleBtn" class="ghost" type="button">Load sample JSON</button>
            <span id="status" role="status" aria-live="polite"></span>
          </div>
        </div>

        <div class="card">
          <h2>How it shapes your Excel</h2>
          <ul class="list">
            <li>Top-level arrays become the main <span class="kbd">Data</span> sheet.</li>
            <li>Nested arrays spin up their own sheets with index columns.</li>
            <li>Objects are flattened with dot notation for nested keys.</li>
            <li>Nulls are blank, and primitive arrays become tidy value rows.</li>
          </ul>
          <p class="help">
            Perfect for "put this JSON into Excel" requests—no manual headers to map. The download is ready immediately after the
            server processes your payload.
          </p>
        </div>
      </section>
      </div>
    </main>

    <script>
      const modeRadios = document.querySelectorAll('input[name="mode"]');
      const jsonText = document.getElementById('jsonText');
      const jsonFile = document.getElementById('jsonFile');
      const dropArea = document.getElementById('dropArea');
      const statusEl = document.getElementById('status');
      const convertBtn = document.getElementById('convertBtn');
      const sampleBtn = document.getElementById('sampleBtn');

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = isError ? 'status-error' : 'status-ok';
      }

      function getMode() {
        return Array.from(modeRadios).find((radio) => radio.checked)?.value || 'text';
      }

      function resetInputsForMode(mode) {
        if (mode === 'text') {
          jsonFile.value = '';
          dropArea.classList.remove('is-dragover');
          dropArea.setAttribute('aria-disabled', 'true');
        } else {
          jsonText.value = '';
          dropArea.removeAttribute('aria-disabled');
        }
      }

      modeRadios.forEach((radio) => {
        radio.addEventListener('change', (event) => {
          resetInputsForMode(event.target.value);
          setStatus('');
        });
      });

      dropArea.addEventListener('click', () => {
        if (getMode() === 'file') {
          jsonFile.click();
        }
      });

      dropArea.addEventListener('dragover', (event) => {
        event.preventDefault();
        if (getMode() === 'file') {
          dropArea.classList.add('is-dragover');
        }
      });

      dropArea.addEventListener('dragleave', () => dropArea.classList.remove('is-dragover'));

      dropArea.addEventListener('drop', (event) => {
        event.preventDefault();
        dropArea.classList.remove('is-dragover');
        if (getMode() !== 'file') return;

        const file = event.dataTransfer.files[0];
        if (file) {
          jsonFile.files = event.dataTransfer.files;
          setStatus(`Ready to upload: ${file.name}`);
        }
      });

      sampleBtn.addEventListener('click', () => {
        const sample = {
          orders: [
            {
              id: 1021,
              customer: 'Acme Industries',
              total: 523.1,
              items: [
                { sku: 'A100', qty: 2, price: 99.99 },
                { sku: 'B240', qty: 1, price: 323.12 }
              ],
              shipping: { city: 'Denver', method: '2-day' }
            },
            {
              id: 1022,
              customer: 'Globex',
              total: 89.25,
              items: [
                { sku: 'A100', qty: 1, price: 99.99 },
                { sku: 'C900', qty: 3, price: 18.25 }
              ],
              shipping: { city: 'Austin', method: 'Ground' }
            }
          ]
        };

        document.querySelector('input[value="text"]').checked = true;
        resetInputsForMode('text');
        jsonText.value = JSON.stringify(sample, null, 2);
        setStatus('Sample JSON loaded. Click "Create Excel" to export.');
      });

      convertBtn.addEventListener('click', async () => {
        const mode = getMode();
        const formData = new FormData();

        if (mode === 'text') {
          const content = jsonText.value.trim();
          if (!content) {
            setStatus('Paste JSON before converting.', true);
            return;
          }
          formData.append('jsonText', content);
        } else {
          const file = jsonFile.files?.[0];
          if (!file) {
            setStatus('Choose or drop a JSON file first.', true);
            return;
          }
          formData.append('file', file);
        }

        setStatus('Converting to Excel…');

        try {
          const response = await fetch('/api/json-to-excel', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            setStatus(error.error || 'Could not convert JSON.', true);
            return;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `json-export-${Date.now()}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);

          setStatus('Excel file generated and download started.', false);
        } catch (err) {
          console.error(err);
          setStatus('Unexpected error converting JSON. Check the console for details.', true);
        }
      });
    </script>
  </body>
</html>
