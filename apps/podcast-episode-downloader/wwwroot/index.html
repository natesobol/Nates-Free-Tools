<!DOCTYPE html>
<html lang="en">
  <head>
  <script id="asset-base-loader">
    (function() {
      const segments = window.location.pathname.split('/').filter(Boolean);
      const repoIndex = segments.indexOf('Nates-Free-Tools');
      const baseHref = repoIndex !== -1 ? '/' + segments.slice(0, repoIndex + 1).join('/') + '/' : '/';
      let baseTag = document.querySelector('base');
      if (!baseTag) {
        baseTag = document.createElement('base');
        document.head.prepend(baseTag);
      }
      baseTag.href = baseHref;
    })();
  </script>
  <link rel="stylesheet" href="css/webapps-unified.css" />
  <script src="public/js/webapps-menu.js" defer></script>
  <script src="js/site-chrome.js" defer></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Podcast Episode Downloader</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --bg: #0b1021;
        --panel: #11162b;
        --accent: #5ad0ff;
        --muted: #9fb0d1;
      }

      body {
        background: radial-gradient(circle at 10% 20%, rgba(90, 208, 255, 0.08), transparent 30%),
          radial-gradient(circle at 90% 20%, rgba(255, 84, 143, 0.08), transparent 30%), var(--bg);
        color: #f0f4ff;
        min-height: 100vh;
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 48px 16px 72px;
      }

      .card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      }

      .hero-title {
        font-size: clamp(2rem, 4vw, 2.75rem);
        margin-bottom: 0.35em;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(90, 208, 255, 0.12);
        color: var(--accent);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.05);
        color: #d0defa;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #0dd867;
        box-shadow: 0 0 12px rgba(13, 216, 103, 0.7);
      }

      .muted {
        color: var(--muted);
      }

      .episode-list {
        display: grid;
        gap: 12px;
      }

      .episode-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 14px 16px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .episode-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 12px;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #5ad0ff, #7a7bff);
        border: none;
        box-shadow: 0 14px 40px rgba(90, 208, 255, 0.35);
      }

      .btn-primary:hover {
        filter: brightness(1.03);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f0f4ff;
      }

      .loading-spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.25);
        border-top-color: #5ad0ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert-info {
        background: rgba(90, 208, 255, 0.15);
        border-color: rgba(90, 208, 255, 0.4);
        color: #d8f5ff;
      }

      .alert-danger {
        background: rgba(255, 99, 132, 0.16);
        border-color: rgba(255, 99, 132, 0.4);
        color: #ffd6de;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
          <div class="pill mb-2">Podcast Episode Downloader</div>
          <h1 class="hero-title">Archive podcast audio from any public RSS feed.</h1>
          <p class="muted mb-0">
            Paste a feed URL or a single episode link, review the metadata, then save episodes as MP3s (zip when selecting more
            than one).
          </p>
        </div>
        <div class="status-pill">
          <span class="status-dot"></span>
          Backend ready
        </div>
      </div>

      <div class="card p-4 mb-4">
        <form id="feed-form" class="row g-3 align-items-center">
          <div class="col-12 col-md-8">
            <label for="feedUrl" class="form-label">RSS feed URL or episode URL</label>
            <input
              type="url"
              class="form-control"
              id="feedUrl"
              name="feedUrl"
              placeholder="https://example.com/feed.xml or https://cdn.podcast.com/episode.mp3"
              required
            />
          </div>
          <div class="col-12 col-md-4 align-self-end d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" type="submit" id="fetchBtn">
              <span class="btn-text">Fetch episodes</span>
              <span class="btn-spinner d-none loading-spinner" aria-hidden="true"></span>
            </button>
            <button class="btn btn-secondary" type="button" id="selectAllBtn" disabled>Select all</button>
          </div>
        </form>
        <div class="mt-3" id="feedback" role="alert"></div>
      </div>

      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="h4 mb-1">Episodes</h2>
            <p class="muted mb-0">Choose one or more episodes to download. Selecting multiple will bundle them as a ZIP.</p>
          </div>
          <button class="btn btn-primary" id="downloadBtn" disabled>Download selected</button>
        </div>
        <div id="episodeList" class="episode-list"></div>
      </div>
    </div>

    <script>
      const feedForm = document.getElementById('feed-form');
      const feedInput = document.getElementById('feedUrl');
      const fetchBtn = document.getElementById('fetchBtn');
      const feedback = document.getElementById('feedback');
      const episodeList = document.getElementById('episodeList');
      const downloadBtn = document.getElementById('downloadBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const spinner = fetchBtn.querySelector('.btn-spinner');
      const btnText = fetchBtn.querySelector('.btn-text');

      let episodes = [];

      feedForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearFeedback();
        toggleFetchLoading(true);
        downloadBtn.disabled = true;
        selectAllBtn.disabled = true;
        episodeList.innerHTML = '';

        try {
          const response = await fetch('/api/fetch-episodes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: feedInput.value.trim() })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({ error: 'Unable to fetch episodes.' }));
            throw new Error(error.error || 'Unable to fetch episodes.');
          }

          const data = await response.json();
          episodes = data.episodes || [];

          if (episodes.length === 0) {
            showFeedback('No episodes were found for that URL.', 'info');
            return;
          }

          renderEpisodes(episodes);
          downloadBtn.disabled = false;
          selectAllBtn.disabled = false;
          showFeedback(`Found ${episodes.length} episode${episodes.length === 1 ? '' : 's'} to download.`, 'info');
        } catch (err) {
          showFeedback(err.message || 'Unable to fetch episodes.', 'danger');
        } finally {
          toggleFetchLoading(false);
        }
      });

      selectAllBtn.addEventListener('click', () => {
        const checkboxes = episodeList.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every((cb) => cb.checked);
        checkboxes.forEach((cb) => (cb.checked = !allChecked));
      });

      downloadBtn.addEventListener('click', async () => {
        const selected = getSelectedEpisodes();
        if (selected.length === 0) {
          showFeedback('Select at least one episode first.', 'danger');
          return;
        }

        downloadBtn.disabled = true;
        downloadBtn.innerHTML = 'Preparing...';
        clearFeedback();

        try {
          const bundle = selected.length > 1;
          const response = await fetch('/api/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ episodes: selected, bundleAsZip: bundle })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({ error: 'Unable to download episodes.' }));
            throw new Error(error.error || 'Unable to download episodes.');
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = bundle ? 'podcast-episodes.zip' : buildFileName(selected[0]);
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          showFeedback('Download started in your browser.', 'info');
        } catch (err) {
          showFeedback(err.message || 'Unable to download episodes.', 'danger');
        } finally {
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = 'Download selected';
        }
      });

      function renderEpisodes(items) {
        episodeList.innerHTML = '';

        items.forEach((episode, index) => {
          const card = document.createElement('div');
          card.className = 'episode-card';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'form-check-input';
          checkbox.id = `episode-${index}`;
          checkbox.value = episode.audioUrl;
          checkbox.dataset.title = episode.title || '';

          const body = document.createElement('div');

          const title = document.createElement('label');
          title.className = 'fw-semibold mb-1';
          title.setAttribute('for', checkbox.id);
          title.textContent = episode.title || 'Untitled episode';

          const meta = document.createElement('div');
          meta.className = 'episode-meta';
          const date = new Date(episode.published);
          meta.innerHTML = `
            <span>üìÖ ${date.toLocaleDateString()}</span>
            ${episode.duration ? `<span>‚è±Ô∏è ${episode.duration}</span>` : ''}
            <span>üîó <a class="link-light" href="${episode.audioUrl}" target="_blank" rel="noopener">Direct audio</a></span>
          `;

          body.appendChild(title);
          body.appendChild(meta);

          card.appendChild(checkbox);
          card.appendChild(body);

          const badge = document.createElement('span');
          badge.className = 'badge text-bg-dark';
          badge.textContent = `#${index + 1}`;
          card.appendChild(badge);

          episodeList.appendChild(card);
        });
      }

      function getSelectedEpisodes() {
        const selected = [];
        const checkboxes = episodeList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((cb) => {
          if (cb.checked) {
            selected.push({ url: cb.value, title: cb.dataset.title });
          }
        });
        return selected;
      }

      function showFeedback(message, type) {
        feedback.className = `alert alert-${type}`;
        feedback.textContent = message;
      }

      function clearFeedback() {
        feedback.className = '';
        feedback.textContent = '';
      }

      function toggleFetchLoading(isLoading) {
        if (isLoading) {
          fetchBtn.disabled = true;
          spinner.classList.remove('d-none');
          btnText.classList.add('d-none');
        } else {
          fetchBtn.disabled = false;
          spinner.classList.add('d-none');
          btnText.classList.remove('d-none');
        }
      }

      function buildFileName(episode) {
        const url = new URL(episode.url);
        const title = episode.title || url.pathname.split('/').pop() || 'episode';
        const ext = url.pathname.split('.').pop();
        return `${title}.${ext || 'mp3'}`.replace(/[^a-z0-9\-_. ]/gi, '-');
      }
    </script>
  </body>
</html>
