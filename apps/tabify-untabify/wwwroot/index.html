<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tabify or Untabify</title>
  <link rel="stylesheet" href="../../../public/css/webapp-theme.css" />
</head>
<body>
  <main>
    <header class="app-header">
      <p class="pill">Text-only C# utility • Tabify or untabify</p>
      <h1>Convert tabs ↔ spaces with preview</h1>
      <p class="muted">Paste any code or plaintext, choose your direction, and preview the converted text before copying it back into your editor.</p>
    </header>

    <section class="card">
      <form id="convert-form">
        <label for="text">Paste text (tabs and spaces supported)</label>
        <textarea id="text" name="text" placeholder="\tIndented line\n    Four leading spaces"></textarea>

        <div class="grid" style="margin-top: 1rem;">
          <div>
            <fieldset>
              <legend>Direction</legend>
              <label><input type="radio" name="mode" value="tabs-to-spaces" checked /> Tabs → Spaces</label>
              <label><input type="radio" name="mode" value="spaces-to-tabs" /> Spaces → Tabs</label>
            </fieldset>
            <label for="spacesPerTab">Spaces per tab</label>
            <input type="number" id="spacesPerTab" name="spacesPerTab" value="4" min="1" max="8" />
            <small class="muted">Clamped between 1 and 8 to match typical coding styles.</small>
          </div>
          <div>
            <label><input type="checkbox" id="trimTrailingWhitespace" name="trimTrailingWhitespace" checked /> Trim trailing whitespace before converting</label>
            <p class="muted">Useful for cleaning up copy/pasted snippets without touching content.</p>
            <button type="submit" style="margin-top: 0.5rem;">Convert</button>
            <div id="error" class="error" style="display:none; margin-top:0.5rem;"></div>
          </div>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top: 1.25rem;">
      <div id="results" style="display:none;">
        <p class="success" id="summary"></p>
        <div class="grid" style="margin-top: 0.75rem;">
          <div class="stat">
            <strong>Converted output</strong>
            <pre id="output"></pre>
          </div>
          <div class="stat">
            <strong>Preview (first 5 lines)</strong>
            <pre id="preview"></pre>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;" id="metrics"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('convert-form');
    const errorBox = document.getElementById('error');
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    const output = document.getElementById('output');
    const preview = document.getElementById('preview');
    const metrics = document.getElementById('metrics');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      errorBox.style.display = 'none';
      results.style.display = 'none';
      metrics.innerHTML = '';

      const data = {
        text: document.getElementById('text').value,
        mode: form.elements['mode'].value,
        spacesPerTab: Number(document.getElementById('spacesPerTab').value) || 4,
        trimTrailingWhitespace: document.getElementById('trimTrailingWhitespace').checked
      };

      try {
        const response = await fetch('/api/convert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Conversion failed.');
        }

        summary.textContent = payload.mode === 'TabsToSpaces'
          ? `Tabs → spaces using ${payload.stats.spacesPerTab} per tab`
          : `Spaces → tabs using ${payload.stats.spacesPerTab} per tab`;

        output.textContent = payload.converted;
        preview.textContent = payload.preview || 'No preview available';

        const badges = [
          `${payload.stats.inputLength} → ${payload.stats.outputLength} characters`,
          `${payload.stats.tabsFound} tabs detected`,
          `${payload.stats.spaceRunsConverted} space runs converted`
        ];

        badges.forEach(text => {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = text;
          metrics.appendChild(pill);
        });

        results.style.display = 'block';
      } catch (error) {
        errorBox.textContent = error.message;
        errorBox.style.display = 'block';
      }
    });
  </script>
</body>
</html>
